<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2dd4bf">
    <meta name="description" content="Family Wealth Dashboard - Portfolio Pro">
    <title>Portfolio Pro - Family Wealth Dashboard</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Apple touch icon support -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0d1117 0%, #090c10 50%, #0a0e14 100%);
            --card-gradient: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            --accent: #2dd4bf;
            --accent-dark: #14b8a6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --card-bg: #161b22;
            --input-bg: #21262d;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            touch-action: pan-y;
        }
        .navbar-custom {
            background: rgba(22,27,34,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        .brand-icon {
            width:40px; height:40px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius:12px;
            display:flex; align-items:center; justify-content:center;
        }
        .brand-icon img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 1px;
        }
        .nav-tabs-custom {
            background: rgba(33,38,45,0.5);
            border-radius:12px;
            padding:4px;
        }
        .nav-tabs-custom .nav-link {
            color: var(--text-secondary);
            border:none;
            border-radius:8px;
            padding:10px 12px;
            font-weight:500;
            font-size: 0.875rem;
            transition:all 0.2s;
        }
        .nav-tabs-custom .nav-link:hover { color:var(--text-primary); background:rgba(45,212,191,0.1); }
        .nav-tabs-custom .nav-link.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color:#0d1117;
        }
        .card-glass, .card-glass-static {
            background: var(--card-gradient);
            border:1px solid var(--border-color);
            border-radius:16px;
            box-shadow:0 4px 16px rgba(0,0,0,0.4);
        }
        .card-glass:hover {
            transform:translateY(-4px);
            border-color:rgba(45,212,191,0.3);
            box-shadow:0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(45,212,191,0.15);
        }
        .stat-value {
            font-size:2.5rem;
            font-weight:700;
            background: linear-gradient(135deg, var(--accent) 0%, #5eead4 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .pill-success {
            background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
            color:white;
            padding:6px 14px;
            border-radius:50px;
            font-size:0.875rem;
            font-weight:500;
            display:inline-flex; align-items:center; gap:4px;
        }
        .pill-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color:white;
            padding:6px 14px;
            border-radius:50px;
            font-size:0.875rem;
            font-weight:500;
            display:inline-flex; align-items:center; gap:4px;
        }
        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color:#0d1117;
            border:none;
            padding:12px 24px;
            border-radius:10px;
            font-weight:600;
            transition:all 0.2s;
            box-shadow:0 2px 8px rgba(0,0,0,0.3);
        }
        .btn-accent:hover {
            transform:translateY(-2px);
            box-shadow:0 4px 16px rgba(0,0,0,0.4), 0 0 20px rgba(45,212,191,0.3);
            color:#0d1117;
        }
        .btn-secondary-custom {
            background:var(--input-bg);
            color:var(--text-primary);
            border:1px solid var(--border-color);
            padding:12px 24px;
            border-radius:10px;
            font-weight:600;
            transition:all 0.2s;
        }
        .btn-secondary-custom:hover {
            background:var(--card-bg);
            border-color:rgba(45,212,191,0.3);
            color:var(--text-primary);
        }
        .form-control-dark {
            background:var(--input-bg);
            border:1px solid var(--border-color);
            color:var(--text-primary);
            border-radius:10px;
            padding:12px 16px;
            transition:all 0.2s;
        }
        .form-control-dark:focus {
            background:var(--input-bg);
            border-color:var(--accent);
            color:var(--text-primary);
            box-shadow:0 0 0 2px rgba(45,212,191,0.2);
        }
        .form-control-dark::placeholder { color:var(--text-secondary); }
        .modal-content-dark {
            background:var(--card-gradient);
            border:1px solid var(--border-color);
            border-radius:20px;
        }
        .modal-header-dark { border-bottom:1px solid var(--border-color); }
        .dropdown-menu-dark-custom {
            background:var(--card-bg);
            border:1px solid var(--border-color);
            border-radius:10px;
            box-shadow:0 8px 32px rgba(0,0,0,0.5);
        }
        .dropdown-item-custom:hover { background:var(--input-bg); }
        .text-muted-custom { color:var(--text-secondary) !important; }
        .empty-state { text-align:center; padding:60px 20px; }
        .empty-state i { font-size:4rem; color:var(--text-secondary); margin-bottom:20px; }
        .chart-container { width:140px; height:140px; }
        .asset-dot {
            width:12px; height:12px;
            border-radius:50%;
            display:inline-block;
        }
        .table-dark-custom {
            --bs-table-bg:transparent;
            --bs-table-color:var(--text-primary);
        }
        .table-dark-custom th {
            color:var(--text-secondary);
            font-weight:500;
            border-bottom:1px solid var(--border-color);
        }
        .table-dark-custom td { border-bottom:1px solid rgba(48,54,61,0.5); }
        .bg-accent-subtle { background:rgba(45,212,191,0.1); }
        .text-success-custom { color:var(--success) !important; }
        .text-accent { color:var(--accent) !important; }
        @media (max-width:768px) {
            .stat-value { font-size:1.75rem; }
            .chart-container { width:120px; height:120px; margin:0 auto; }
        }
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-custom sticky-top d-none">
        <div class="container">
            <div class="d-flex align-items-center gap-3">
                <div class="brand-icon">
                    <img src="port_image.png" alt="Portfolio Pro" />
                </div>
                <div>
                    <h1 class="h5 mb-0 fw-bold">Portfolio Pro</h1>
                    <small class="text-muted-custom">Family Wealth Dashboard</small>
                </div>
            </div>
            <ul class="nav nav-tabs-custom" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Dashboard</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="projections-tab" data-bs-toggle="tab" data-bs-target="#projections" type="button">Projections</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sip-tab" data-bs-toggle="tab" data-bs-target="#sip" type="button">SIP Calculator</button>
                </li>
            </ul>
        </div>
    </nav>
    <main class="container py-4 no-select d-none" id="swipeArea">
        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card-glass-static p-4 p-md-5 mb-4">
                    <div class="row align-items-center">
                        <div class="col-lg-7">
                            <p class="text-muted-custom text-uppercase small mb-2 letter-spacing-1">Family Net Worth</p>
                            <h2 class="stat-value mb-4" id="currentValue">₹0</h2>
                            <div class="d-flex flex-wrap gap-4">
                                <div>
                                    <p class="text-muted-custom small mb-1">Total Invested</p>
                                    <p class="fs-5 fw-semibold mb-0" id="totalInvested">₹0</p>
                                </div>
                                <div>
                                    <p class="text-muted-custom small mb-1">Overall Returns</p>
                                    <span id="returnPill" class="pill-success">
                                        <span id="returnPercentage">0.00%</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 mt-4 mt-lg-0">
                            <div class="d-flex flex-wrap gap-3 justify-content-lg-end">
                                <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#portfolioModal" onclick="openAddPortfolio()">
                                    <i class="bi bi-plus-lg me-2"></i>Add Portfolio
                                </button>
                                <button class="btn btn-secondary-custom" data-bs-toggle="modal" data-bs-target="#returnsModal">
                                    <i class="bi bi-cash-coin me-2"></i>Total Returns
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="portfoliosContainer" class="row g-4"></div>
            </div>
            <div class="tab-pane fade" id="projections" role="tabpanel">
                <div class="card-glass-static p-4 mb-4">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <i class="bi bi-gear text-accent"></i>
                        <h5 class="mb-0 fw-semibold">CAGR Assumptions (Expected Future Returns)</h5>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label text-muted-custom small">Equity (%)</label>
                            <input type="number" class="form-control form-control-dark" id="cagrEquity" step="0.5" min="0" max="30">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted-custom small">Debt (%)</label>
                            <input type="number" class="form-control form-control-dark" id="cagrDebt" step="0.5" min="0" max="15">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted-custom small">Gold (%)</label>
                            <input type="number" class="form-control form-control-dark" id="cagrGold" step="0.5" min="0" max="20">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted-custom small">Others (%)</label>
                            <input type="number" class="form-control form-control-dark" id="cagrOthers" step="0.5" min="-5" max="15">
                        </div>
                    </div>
                    <p class="text-muted-custom small mt-3 mb-0">
                        * Categories detected from asset names. Use keywords like: Equity, Debt, Gold, etc.
                    </p>
                </div>
                <div id="projectionsContainer"></div>
            </div>
            <div class="tab-pane fade" id="sip" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card-glass-static p-4">
                            <h5 class="fw-semibold mb-4">SIP / Lumpsum Calculator</h5>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Investment Type</label>
                                <select class="form-select form-control-dark" id="investType">
                                    <option value="sip">SIP (Monthly)</option>
                                    <option value="lumpsum">Lumpsum</option>
                                </select>
                            </div>
                            <div id="sipInputs">
                                <div class="mb-3">
                                    <label class="form-label text-muted-custom small">Monthly Investment (₹)</label>
                                    <input type="number" class="form-control form-control-dark" id="monthlyAmt" min="100" value="5000">
                                </div>
                            </div>
                            <div id="lumpsumInputs" style="display:none;">
                                <div class="mb-3">
                                    <label class="form-label text-muted-custom small">Lumpsum Amount (₹)</label>
                                    <input type="number" class="form-control form-control-dark" id="lumpsumAmt" min="100" value="100000">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Expected Return Rate (% p.a.)</label>
                                <input type="number" class="form-control form-control-dark" id="returnRate" step="0.1" min="0" value="12">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Investment Period (Years)</label>
                                <input type="number" class="form-control form-control-dark" id="periodYears" min="1" value="10">
                            </div>
                            <div id="sipResults" class="d-none">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted-custom">Invested Amount</span>
                                    <span id="investedAmt">₹0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted-custom">Est. Returns</span>
                                    <span id="estReturns" class="text-success-custom">₹0</span>
                                </div>
                                <hr class="border-secondary">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-semibold">Total Value</span>
                                    <span id="totalValue" class="fw-bold text-accent">₹0</span>
                                </div>
                                <small class="text-muted-custom d-block mt-2">
                                    • Assumes investment at the <strong>beginning of each month</strong> (standard Groww / most Indian calculator convention)<br>
                                    • Uses true monthly rate derived from annual CAGR → more realistic<br>
                                    • Compounded monthly • No exit load / taxes considered
                                </small>
                                <div class="chart-container mt-4" style="height:200px;">
                                    <canvas id="sipChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card-glass-static p-4">
                            <h5 class="fw-semibold mb-4">Step-up SIP Calculator</h5>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Monthly Investment (₹)</label>
                                <input type="number" class="form-control form-control-dark" id="stepMonthlyAmt" min="100" value="5000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Annual Step-up (%)</label>
                                <input type="number" class="form-control form-control-dark" id="stepUpPct" step="0.1" min="0" value="10">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Expected Return Rate (% p.a.)</label>
                                <input type="number" class="form-control form-control-dark" id="stepReturnRate" step="0.1" min="0" value="12">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted-custom small">Investment Period (Years)</label>
                                <input type="number" class="form-control form-control-dark" id="stepPeriodYears" min="1" value="10">
                            </div>
                            <div id="stepSipResults" class="d-none">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted-custom">Invested Amount</span>
                                    <span id="stepInvestedAmt">₹0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted-custom">Est. Returns</span>
                                    <span id="stepEstReturns" class="text-success-custom">₹0</span>
                                </div>
                                <hr class="border-secondary">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-semibold">Total Value</span>
                                    <span id="stepTotalValue" class="fw-bold text-accent">₹0</span>
                                </div>
                                <div class="chart-container mt-4" style="height:200px;">
                                    <canvas id="stepSipChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Portfolio Modal -->
    <div class="modal fade" id="portfolioModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-content-dark">
                <div class="modal-header modal-header-dark border-0 pb-0">
                    <h5 class="modal-title fw-semibold" id="portfolioModalTitle">Add Portfolio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="portfolioForm">
                        <input type="hidden" id="editingPortfolioId">
                        <div class="mb-4">
                            <label class="form-label text-muted-custom small">Portfolio Name</label>
                            <input type="text" class="form-control form-control-dark" id="portfolioName" placeholder="e.g., My Retirement Fund" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-muted-custom small">Total Invested Amount (₹)</label>
                            <input type="number" class="form-control form-control-dark" id="portfolioAmount" placeholder="Enter amount" min="1" required oninput="recalculateAssetAmounts()">
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label text-muted-custom small mb-0">Asset Allocation</label>
                                <span id="allocationTotal" class="small fw-medium text-warning">Total: 0%</span>
                            </div>
                            <div id="assetsContainer"></div>
                            <button type="button" class="btn btn-link text-accent text-decoration-none p-0 mt-2" onclick="addAssetRow()">
                                <i class="bi bi-plus-lg me-1"></i>Add Asset
                            </button>
                        </div>
                        <div id="portfolioError" class="alert alert-danger d-none"></div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-accent" onclick="savePortfolio()">Save Portfolio</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Returns Modal -->
    <div class="modal fade" id="returnsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content modal-content-dark">
                <div class="modal-header modal-header-dark border-0 pb-0">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-graph-up-arrow text-accent me-2"></i>Total Returns / Unrealized Gain/Loss
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label text-muted-custom small">Total Profit/Loss Across All Portfolios (₹)</label>
                        <input type="number" class="form-control form-control-dark" id="totalReturnsInput" placeholder="Enter total returns (can be negative)" oninput="previewReturns()">
                        <small class="text-muted-custom">Positive = profit/gain • Negative = loss</small>
                    </div>
                    <div class="bg-dark rounded-3 p-3">
                        <div class="d-flex justify-content-between small mb-2">
                            <span class="text-muted-custom">Total Invested</span>
                            <span id="previewInvested">₹0</span>
                        </div>
                        <div class="d-flex justify-content-between small mb-2">
                            <span class="text-muted-custom">Returns</span>
                            <span id="previewReturns" class="text-success-custom">+₹0</span>
                        </div>
                        <hr class="border-secondary my-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted-custom">Current Value</span>
                            <span id="previewValue" class="fw-bold">₹0</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted-custom">Return %</span>
                            <span id="previewReturnPct" class="pill-success">+0.00%</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-accent" onclick="saveReturns()">Save Returns</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyAin_GBduiKa7le4avmVcHdwEoNL5EdAko",
            authDomain: "portfolio-f938c.firebaseapp.com",
            projectId: "portfolio-f938c",
            storageBucket: "portfolio-f938c.firebasestorage.app",
            messagingSenderId: "963544931671",
            appId: "1:963544931671:web:ff0210cc532428ea227212",
            measurementId: "G-C41JE44L43",
            databaseURL: "https://portfolio-f938c-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        enableIndexedDbPersistence(db).catch((err) => {
            console.warn("IndexedDB persistence issue:", err);
        });
        const DOC_REF = doc(db, "shared", "family-portfolio-data");
        const PASSWORD_REF = ref(rtdb, "appPassword");
        // ──── COLOR DEFINITIONS ───────────────────────────────────────────────
        const CATEGORY_COLORS = {
            equity: '#ef4444', // red-500
            debt: '#22c55e', // green-500
            gold: '#eab308', // amber-500 / gold tone
        };
        const OTHERS_COLORS = [
            '#6b7280', '#9ca3af', '#64748b', '#475569', '#334155'
        ];
        function getAssetColor(category, indexForOthers = 0) {
            if (category in CATEGORY_COLORS) {
                return CATEGORY_COLORS[category];
            }
            return OTHERS_COLORS[indexForOthers % OTHERS_COLORS.length];
        }
        let appState = {
            portfolios: [],
            totalReturns: 0,
            cagrAssumptions: {
                equity: 13,
                debt: 7.5,
                gold: 9,
                others: 2
            }
        };
        let chartInstances = {};
        let isSaving = false;
        // ────────────────────────────────────────────────
        // Improved swipe handling
        // ────────────────────────────────────────────────
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const swipeThreshold = 70;
        const swipeArea = document.getElementById('swipeArea');
        swipeArea.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            const scrollable = e.target.closest('.table-responsive');
            swipeArea.dataset.touchStartedInScrollable = scrollable ? 'true' : 'false';
        }, { passive: true });
        swipeArea.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });
        function handleSwipe() {
            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);
            if (diffY > 50) return;
            if (swipeArea.dataset.touchStartedInScrollable === 'true' && Math.abs(diffX) > 40) return;
            if (Math.abs(diffX) < swipeThreshold) return;
            const tabButtons = Array.from(document.querySelectorAll('#mainTabs .nav-link'));
            const currentIdx = tabButtons.findIndex(b => b.classList.contains('active'));
            let newIdx;
            if (diffX > 0) { // swipe left → next
                newIdx = (currentIdx + 1) % tabButtons.length;
            } else { // swipe right → previous
                newIdx = (currentIdx - 1 + tabButtons.length) % tabButtons.length;
            }
            bootstrap.Tab.getOrCreateInstance(tabButtons[newIdx]).show();
            swipeArea.dataset.touchStartedInScrollable = 'false';
        }
        // ────────────────────────────────────────────────
        // Helper functions
        // ────────────────────────────────────────────────
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(Math.round(amount));
        }
        function generateId() {
            return Math.random().toString(36).substring(2, 9);
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function sortAssetsByPercentage(assets) {
            return [...assets].sort((a, b) => b.percentage - a.percentage);
        }
        function getTotalInvested() {
            return appState.portfolios.reduce((sum, p) => sum + (p.totalInvested || 0), 0);
        }
        function getCurrentValue() {
            return getTotalInvested() + appState.totalReturns;
        }
        function getReturnPercentage() {
            const invested = getTotalInvested();
            return invested > 0 ? (appState.totalReturns / invested) * 100 : 0;
        }
        function calculateFutureValue(principal, rate, years) {
            return principal * Math.pow(1 + rate / 100, years);
        }
        function getAssetCategory(assetName) {
            const name = assetName.toLowerCase();
            if (/equity|stock|share|mf|mutual fund|nifty|sensex|midcap|smallcap/.test(name)) return 'equity';
            if (/debt|bond|fd|fixed deposit|ppf|rd|corporate bond|gilt/.test(name)) return 'debt';
            if (/gold|sgb|gold etf|gold fund|digital gold/.test(name)) return 'gold';
            return 'others';
        }
        function getCagrAssumptions() {
            return appState.cagrAssumptions || { equity: 13, debt: 7.5, gold: 9, others: 2 };
        }
        // ────────────────────────────────────────────────
        // Firestore
        // ────────────────────────────────────────────────
        async function loadState() {
            try {
                const snap = await getDoc(DOC_REF);
                if (snap.exists()) {
                    const data = snap.data();
                    appState.portfolios = (data.portfolios || []).map(p => ({
                        ...p,
                        assets: sortAssetsByPercentage(p.assets)
                    }));
                    appState.totalReturns = data.totalReturns || 0;
                    appState.cagrAssumptions = data.cagrAssumptions || { equity: 13, debt: 7.5, gold: 9, others: 2 };
                }
            } catch (e) {
                console.error("Error loading from Firestore:", e);
            }
        }
        async function saveState() {
            if (isSaving) return;
            isSaving = true;
            try {
                await setDoc(DOC_REF, appState);
            } catch (e) {
                console.error("Error saving to Firestore:", e);
            } finally {
                isSaving = false;
            }
        }
        async function saveCagrAssumptions() {
            if (isSaving) return;
            isSaving = true;
            try {
                await setDoc(DOC_REF, { cagrAssumptions: appState.cagrAssumptions }, { merge: true });
            } catch (e) {
                console.error("Error saving CAGR:", e);
            } finally {
                isSaving = false;
            }
        }
        // ────────────────────────────────────────────────
        // Password logic (SHA-256)
        // ────────────────────────────────────────────────
        async function sha256(str) {
            const msgBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
        }
        async function checkOrSetPassword() {
            const nav = document.querySelector('nav');
            const main = document.querySelector('main');
            nav.classList.add('d-none');
            main.classList.add('d-none');
            const modalHtml = `
<div class="modal fade" id="passwordModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark border-0 shadow-lg">
            <div class="modal-body text-center py-5 px-5">
                <i class="bi bi-shield-lock text-accent mb-4" style="font-size: 3.5rem; opacity: 0.92;"></i>
                <h4 class="fw-bold mb-4">Portfolio Pro</h4>
                <p class="text-muted-custom mb-4" id="pwdMessage">
                    Secure access required
                </p>
                <input type="password" class="form-control form-control-dark mb-4 text-center"
                       id="pwdInput" placeholder="••••••••" autocomplete="off" autofocus>
                <button class="btn btn-accent w-100 py-3 fw-semibold" id="pwdSubmit">Unlock</button>
                <div id="pwdError" class="alert alert-danger mt-3 d-none small"></div>
            </div>
        </div>
    </div>
</div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const pwdModalEl = document.getElementById('passwordModal');
            const pwdInput = document.getElementById('pwdInput');
            const pwdSubmit = document.getElementById('pwdSubmit');
            const pwdError = document.getElementById('pwdError');
            const pwdMessage = document.getElementById('pwdMessage');
            const modal = new bootstrap.Modal(pwdModalEl, { backdrop: 'static', keyboard: false });
            modal.show();
            let hasPassword = false;
            let storedHash = null;
            try {
                const snap = await get(PASSWORD_REF);
                hasPassword = snap.exists() && typeof snap.val() === 'string' && snap.val().length >= 64;
                if (hasPassword) storedHash = snap.val();
            } catch (err) {
                console.error("Firebase read failed:", err);
                pwdError.textContent = "Cannot connect to database. Check internet / Firebase rules.";
                pwdError.classList.remove('d-none');
                pwdSubmit.disabled = true;
                return;
            }
            if (!hasPassword) {
                pwdMessage.textContent = "First time setup – create your password (min 6 chars)";
                pwdInput.placeholder = "Create password";
            }
            pwdSubmit.onclick = async () => {
                pwdError.classList.add('d-none');
                pwdSubmit.disabled = true;
                pwdSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Checking...';
                const val = pwdInput.value.trim();
                if (val.length < 6) {
                    pwdError.textContent = "Password must be at least 6 characters";
                    pwdError.classList.remove('d-none');
                    pwdSubmit.disabled = false;
                    pwdSubmit.textContent = 'Unlock';
                    return;
                }
                let hash;
                try {
                    hash = await sha256(val);
                } catch (err) {
                    pwdError.textContent = "Security error – try another browser";
                    pwdError.classList.remove('d-none');
                    pwdSubmit.disabled = false;
                    pwdSubmit.textContent = 'Unlock';
                    return;
                }
                if (!hasPassword) {
                    try {
                        await set(PASSWORD_REF, hash);
                        unlock();
                    } catch (err) {
                        console.error("Firebase write failed:", err);
                        pwdError.textContent = "Failed to save password. Check Firebase rules & internet.";
                        pwdError.classList.remove('d-none');
                        pwdSubmit.disabled = false;
                        pwdSubmit.textContent = 'Unlock';
                    }
                } else {
                    if (hash === storedHash) {
                        unlock();
                    } else {
                        pwdError.textContent = "Incorrect password";
                        pwdError.classList.remove('d-none');
                        pwdInput.value = '';
                        pwdInput.focus();
                        pwdSubmit.disabled = false;
                        pwdSubmit.textContent = 'Unlock';
                    }
                }
            };
            pwdInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !pwdSubmit.disabled) pwdSubmit.click();
            });
        }
        function unlock() {
            const modalEl = document.getElementById('passwordModal');
            bootstrap.Modal.getInstance(modalEl)?.hide();
            document.querySelector('nav').classList.remove('d-none');
            document.querySelector('main').classList.remove('d-none');
            document.getElementById('passwordModal')?.remove();
            initApp();
        }
        // ────────────────────────────────────────────────
        // App init after password
        // ────────────────────────────────────────────────
        async function initApp() {
            await loadState();
            document.getElementById('cagrEquity').value = appState.cagrAssumptions.equity;
            document.getElementById('cagrDebt').value = appState.cagrAssumptions.debt;
            document.getElementById('cagrGold').value = appState.cagrAssumptions.gold;
            document.getElementById('cagrOthers').value = appState.cagrAssumptions.others;
            ['cagrEquity','cagrDebt','cagrGold','cagrOthers'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateAndSaveCagr);
            });
            document.getElementById('investType')?.addEventListener('change', function() {
                document.getElementById('sipInputs').style.display = this.value === 'sip' ? 'block' : 'none';
                document.getElementById('lumpsumInputs').style.display = this.value === 'lumpsum' ? 'block' : 'none';
                calculateSipLumpsum();
            });
            ['monthlyAmt', 'lumpsumAmt', 'returnRate', 'periodYears'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateSipLumpsum);
            });
            ['stepMonthlyAmt', 'stepUpPct', 'stepReturnRate', 'stepPeriodYears'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateStepUpSip);
            });
            updateNetWorthDisplay();
            renderPortfolios();
            updateProjections();
            document.getElementById('projections-tab')?.addEventListener('shown.bs.tab', updateProjections);
            calculateSipLumpsum();
            calculateStepUpSip();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW failed', err));
            }
        }
        // ────────────────────────────────────────────────
        // Render & update functions
        // ────────────────────────────────────────────────
        function updateNetWorthDisplay() {
            document.getElementById('totalInvested').textContent = formatCurrency(getTotalInvested());
            document.getElementById('currentValue').textContent = formatCurrency(getCurrentValue());
            const returnPct = getReturnPercentage();
            const isPositive = returnPct >= 0;
            const pill = document.getElementById('returnPill');
            const pctEl = document.getElementById('returnPercentage');
            pill.className = isPositive ? 'pill-success' : 'pill-danger';
            pctEl.textContent = `${isPositive ? '+' : ''}${returnPct.toFixed(2)}%`;
        }
        function renderPortfolios() {
            const container = document.getElementById('portfoliosContainer');
            if (appState.portfolios.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card-glass-static empty-state">
                            <i class="bi bi-briefcase"></i>
                            <h4 class="fw-semibold mb-2">No Portfolios Yet</h4>
                            <p class="text-muted-custom mb-4">Start building your family wealth dashboard by adding your first portfolio.</p>
                            <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#portfolioModal" onclick="openAddPortfolio()">
                                Add Your First Portfolio
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            const sortedPortfolios = appState.portfolios.map(p => ({
                ...p,
                assets: sortAssetsByPercentage(p.assets)
            }));
            container.innerHTML = sortedPortfolios.map(p => `
                <div class="col-lg-6">
                    <div class="card-glass p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="fw-semibold mb-0">${escapeHtml(p.name)}</h5>
                            <div class="dropdown">
                                <button class="btn btn-link text-muted-custom p-1" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark-custom dropdown-menu-end">
                                    <li><a class="dropdown-item dropdown-item-custom" href="#" onclick="editPortfolio('${p.id}')"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item dropdown-item-custom text-danger" href="#" onclick="deletePortfolio('${p.id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <p class="text-muted-custom small mb-1">Total Invested</p>
                        <p class="fs-4 fw-bold mb-4">${formatCurrency(p.totalInvested)}</p>
                        <div class="row align-items-center">
                            <div class="col-5">
                                <div class="chart-container">
                                    <canvas id="chart-${p.id}"></canvas>
                                </div>
                            </div>
                            <div class="col-7">
                                <p class="text-muted-custom small mb-2">Asset Breakdown (Sorted by Allocation)</p>
                                ${p.assets.map((a, i) => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="asset-dot" style="background:${getAssetColor(getAssetCategory(a.name), i)}"></span>
                                            <span class="small">${escapeHtml(a.name)}</span>
                                        </div>
                                        <div class="text-end">
                                            <span class="small fw-medium">${a.percentage}%</span>
                                            <span class="small text-muted-custom ms-1">(${formatCurrency(a.amount)})</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            setTimeout(() => appState.portfolios.forEach(p => renderChart(p)), 50);
        }
        function renderChart(portfolio) {
            const canvas = document.getElementById(`chart-${portfolio.id}`);
            if (!canvas) return;
            if (chartInstances[portfolio.id]) chartInstances[portfolio.id].destroy();
            const sortedAssets = sortAssetsByPercentage(portfolio.assets);
            const colors = sortedAssets.map((a, idx) =>
                getAssetColor(getAssetCategory(a.name), idx)
            );
            chartInstances[portfolio.id] = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: sortedAssets.map(a => a.name),
                    datasets: [{
                        data: sortedAssets.map(a => a.percentage),
                        backgroundColor: colors,
                        borderColor: '#161b22',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    rotation: -180,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        function openAddPortfolio() {
            document.getElementById('portfolioModalTitle').textContent = 'Add Portfolio';
            document.getElementById('editingPortfolioId').value = '';
            document.getElementById('portfolioName').value = '';
            document.getElementById('portfolioAmount').value = '';
            document.getElementById('portfolioError').classList.add('d-none');
            document.getElementById('assetsContainer').innerHTML = '';
            addAssetRow();
        }
        function editPortfolio(id) {
            const p = appState.portfolios.find(x => x.id === id);
            if (!p) return;
            document.getElementById('portfolioModalTitle').textContent = 'Edit Portfolio';
            document.getElementById('editingPortfolioId').value = id;
            document.getElementById('portfolioName').value = p.name;
            document.getElementById('portfolioAmount').value = p.totalInvested;
            document.getElementById('portfolioError').classList.add('d-none');
            document.getElementById('assetsContainer').innerHTML = '';
            p.assets.forEach(a => addAssetRow(a.name, a.percentage));
            recalculateAssetAmounts();
            new bootstrap.Modal(document.getElementById('portfolioModal')).show();
        }
        function addAssetRow(name = '', percentage = '') {
            const container = document.getElementById('assetsContainer');
            const id = generateId();
            const total = parseFloat(document.getElementById('portfolioAmount').value) || 0;
            const amount = (parseFloat(percentage) || 0) / 100 * total;
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 asset-row';
            row.id = `asset-${id}`;
            row.innerHTML = `
                <div class="col">
                    <input type="text" class="form-control form-control-dark form-control-sm asset-name" placeholder="Asset name (e.g., Equity MF, PPF, Gold)" value="${escapeHtml(name)}">
                </div>
                <div class="col-3">
                    <input type="number" class="form-control form-control-dark form-control-sm asset-percentage text-center" placeholder="0%" min="0" max="100" value="${percentage}" oninput="updateAllocationTotal()">
                </div>
                <div class="col-3">
                    <input type="text" class="form-control form-control-dark form-control-sm asset-amount text-end" value="${amount > 0 ? formatCurrency(amount) : ''}" disabled>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-link text-muted-custom p-2" onclick="removeAssetRow('${id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(row);
            updateAllocationTotal();
        }
        function removeAssetRow(id) {
            const rows = document.querySelectorAll('.asset-row');
            if (rows.length > 1) {
                document.getElementById(`asset-${id}`).remove();
                updateAllocationTotal();
            }
        }
        function updateAllocationTotal() {
            let total = 0;
            document.querySelectorAll('.asset-percentage').forEach(el => total += parseFloat(el.value) || 0);
            const el = document.getElementById('allocationTotal');
            const valid = Math.abs(total - 100) <= 0.01;
            el.textContent = `Total: ${total.toFixed(1)}%`;
            el.className = `small fw-medium ${valid ? 'text-success-custom' : 'text-warning'}`;
            recalculateAssetAmounts();
        }
        function recalculateAssetAmounts() {
            const total = parseFloat(document.getElementById('portfolioAmount').value) || 0;
            document.querySelectorAll('.asset-row').forEach(row => {
                const pct = parseFloat(row.querySelector('.asset-percentage').value) || 0;
                const amt = pct / 100 * total;
                row.querySelector('.asset-amount').value = amt > 0 ? formatCurrency(amt) : '';
            });
        }
        async function savePortfolio() {
            const err = document.getElementById('portfolioError');
            err.classList.add('d-none');
            const id = document.getElementById('editingPortfolioId').value;
            const name = document.getElementById('portfolioName').value.trim();
            const totalInvested = parseFloat(document.getElementById('portfolioAmount').value);
            if (!name) { err.textContent = 'Portfolio name is required'; err.classList.remove('d-none'); return; }
            if (!totalInvested || totalInvested <= 0) { err.textContent = 'Total invested must be > 0'; err.classList.remove('d-none'); return; }
            let assets = [];
            document.querySelectorAll('.asset-row').forEach(row => {
                const n = row.querySelector('.asset-name').value.trim();
                const pct = parseFloat(row.querySelector('.asset-percentage').value) || 0;
                if (n && pct > 0) {
                    assets.push({ id: generateId(), name: n, percentage: pct, amount: pct / 100 * totalInvested });
                }
            });
            if (assets.length === 0) { err.textContent = 'At least one asset required'; err.classList.remove('d-none'); return; }
            const sumPct = assets.reduce((s,a)=>s+a.percentage,0);
            if (Math.abs(sumPct - 100) > 0.01) {
                err.textContent = `Allocation must total 100% (currently ${sumPct.toFixed(1)}%)`; err.classList.remove('d-none'); return;
            }
            assets = sortAssetsByPercentage(assets);
            const portfolio = { id: id || generateId(), name, totalInvested, assets };
            if (id) {
                const idx = appState.portfolios.findIndex(p => p.id === id);
                if (idx !== -1) appState.portfolios[idx] = portfolio;
            } else {
                appState.portfolios.push(portfolio);
            }
            await saveState();
            renderPortfolios();
            updateNetWorthDisplay();
            updateProjections();
            bootstrap.Modal.getInstance(document.getElementById('portfolioModal')).hide();
        }
        async function deletePortfolio(id) {
            if (!confirm('Delete this portfolio?')) return;
            appState.portfolios = appState.portfolios.filter(p => p.id !== id);
            if (chartInstances[id]) {
                chartInstances[id].destroy();
                delete chartInstances[id];
            }
            await saveState();
            renderPortfolios();
            updateNetWorthDisplay();
            updateProjections();
        }
        function previewReturns() {
            const ret = parseFloat(document.getElementById('totalReturnsInput').value) || 0;
            const inv = getTotalInvested();
            const val = inv + ret;
            const pct = inv > 0 ? (ret / inv) * 100 : 0;
            const pos = ret >= 0;
            document.getElementById('previewInvested').textContent = formatCurrency(inv);
            document.getElementById('previewReturns').textContent = `${pos ? '+' : ''}${formatCurrency(ret)}`;
            document.getElementById('previewReturns').className = pos ? 'text-success-custom' : 'text-danger';
            document.getElementById('previewValue').textContent = formatCurrency(val);
            const pctEl = document.getElementById('previewReturnPct');
            pctEl.className = pos ? 'pill-success' : 'pill-danger';
            pctEl.textContent = `${pos ? '+' : ''}${pct.toFixed(2)}%`;
        }
        async function saveReturns() {
            appState.totalReturns = parseFloat(document.getElementById('totalReturnsInput').value) || 0;
            await saveState();
            updateNetWorthDisplay();
            updateProjections();
            bootstrap.Modal.getInstance(document.getElementById('returnsModal')).hide();
        }
        document.getElementById('returnsModal').addEventListener('show.bs.modal', () => {
            document.getElementById('totalReturnsInput').value = appState.totalReturns;
            previewReturns();
        });
        async function updateAndSaveCagr() {
            appState.cagrAssumptions = {
                equity: parseFloat(document.getElementById('cagrEquity').value) || 13,
                debt: parseFloat(document.getElementById('cagrDebt').value) || 7.5,
                gold: parseFloat(document.getElementById('cagrGold').value) || 9,
                others: parseFloat(document.getElementById('cagrOthers').value) || 2
            };
            updateProjections();
            await saveCagrAssumptions();
        }
        function updateProjections() {
            const container = document.getElementById('projectionsContainer');
            if (appState.portfolios.length === 0) {
                container.innerHTML = `
                    <div class="card-glass-static empty-state">
                        <i class="bi bi-graph-up-arrow"></i>
                        <h4 class="fw-semibold mb-2">No Portfolios Yet</h4>
                        <p class="text-muted-custom">Add portfolios in Overview to see projections.</p>
                    </div>
                `;
                return;
            }
            const rates = getCagrAssumptions();
            let grand = { current: 0, y5: 0, y10: 0, y15: 0, wCagr: 0 };
            const portfolioProjections = appState.portfolios.map(p => {
                const totalInvAll = getTotalInvested();
                const share = totalInvAll > 0 ? p.totalInvested / totalInvAll : 0;
                const portReturns = appState.totalReturns * share;
                const portCurrent = p.totalInvested + portReturns;
                const sortedAssets = sortAssetsByPercentage(p.assets);
                const assetProj = sortedAssets.map(a => {
                    const cat = getAssetCategory(a.name);
                    const r = rates[cat];
                    return {
                        ...a,
                        category: cat,
                        rate: r,
                        y5: calculateFutureValue(a.amount, r, 5),
                        y10: calculateFutureValue(a.amount, r, 10),
                        y15: calculateFutureValue(a.amount, r, 15)
                    };
                });
                const portWCagr = assetProj.reduce((s,a) => s + (a.rate * (a.amount / p.totalInvested)), 0) || 0;
                const pY5 = calculateFutureValue(portCurrent, portWCagr, 5);
                const pY10 = calculateFutureValue(portCurrent, portWCagr, 10);
                const pY15 = calculateFutureValue(portCurrent, portWCagr, 15);
                grand.current += portCurrent;
                grand.y5 += pY5;
                grand.y10 += pY10;
                grand.y15 += pY15;
                grand.wCagr += portWCagr * (portCurrent / (grand.current || 1));
                const assetSumY5 = assetProj.reduce((s,a)=>s+a.y5, 0);
                const assetSumY10 = assetProj.reduce((s,a)=>s+a.y10, 0);
                const assetSumY15 = assetProj.reduce((s,a)=>s+a.y15, 0);
                return { name: p.name, portCurrent, portWCagr, pY5, pY10, pY15, assetProj, assetSumY5, assetSumY10, assetSumY15, totalInvested: p.totalInvested };
            });
            if (grand.current > 0) {
                grand.wCagr = 0;
                portfolioProjections.forEach(proj => {
                    grand.wCagr += proj.portWCagr * (proj.portCurrent / grand.current);
                });
            }
            const grandHtml = `
                <div class="card-glass-static p-4 mb-4">
                    <h5 class="fw-semibold mb-3">Total Family Wealth Projection (Compounded from Today)</h5>
                    <div class="table-responsive">
                        <table class="table table-dark-custom mb-0">
                            <thead><tr><th>Metric</th><th class="text-end">Current Value</th><th class="text-end">5 Years</th><th class="text-end">10 Years</th><th class="text-end">15 Years</th></tr></thead>
                            <tbody>
                                <tr class="bg-accent-subtle">
                                    <td class="fw-semibold">All Portfolios</td>
                                    <td class="text-end fw-medium">${formatCurrency(grand.current)}</td>
                                    <td class="text-end fw-medium text-success-custom">${formatCurrency(grand.y5)}</td>
                                    <td class="text-end fw-medium text-success-custom">${formatCurrency(grand.y10)}</td>
                                    <td class="text-end fw-medium text-success-custom">${formatCurrency(grand.y15)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 pt-3 border-top border-secondary">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Family Weighted Expected CAGR</span>
                            <span class="fs-5 fw-bold text-accent">${grand.current > 0 ? grand.wCagr.toFixed(1) : '—'}%</span>
                        </div>
                        <small class="text-muted-custom d-block mt-1">Weighted average of each portfolio's expected CAGR (by current value allocation)</small>
                    </div>
                    <small class="text-muted-custom d-block mt-4">
                        • Starting from current net worth: ${formatCurrency(getCurrentValue())}<br>
                        • Each portfolio compounds at its own weighted expected CAGR
                    </small>
                </div>
            `;
            const html = portfolioProjections.map(proj => `
                <div class="card-glass-static p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-semibold mb-0">${escapeHtml(proj.name)}</h5>
                        <span class="text-muted-custom small">Weighted CAGR: <span class="text-accent fw-medium">${proj.portWCagr.toFixed(1)}%</span></span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark-custom mb-0">
                            <thead><tr><th>Asset</th><th class="text-end">Category</th><th class="text-end">CAGR</th><th class="text-end">Invested</th><th class="text-end">5 Yr</th><th class="text-end">10 Yr</th><th class="text-end">15 Yr</th></tr></thead>
                            <tbody>
                                ${proj.assetProj.map((a, i) => `
                                    <tr>
                                        <td>${escapeHtml(a.name)}</td>
                                        <td class="text-end text-muted-custom">${a.category}</td>
                                        <td class="text-end text-accent">${a.rate}%</td>
                                        <td class="text-end text-muted-custom">${formatCurrency(a.amount)}</td>
                                        <td class="text-end">${formatCurrency(a.y5)}</td>
                                        <td class="text-end">${formatCurrency(a.y10)}</td>
                                        <td class="text-end">${formatCurrency(a.y15)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="bg-dark">
                                    <td colspan="3" class="fw-semibold">Asset-level totals (from invested)</td>
                                    <td class="text-end fw-semibold">${formatCurrency(proj.totalInvested)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.assetSumY5)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.assetSumY10)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.assetSumY15)}</td>
                                </tr>
                                <tr class="bg-accent-subtle">
                                    <td colspan="3" class="fw-semibold">Portfolio projection (from current value)</td>
                                    <td class="text-end fw-semibold">${formatCurrency(proj.portCurrent)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.pY5)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.pY10)}</td>
                                    <td class="text-end fw-semibold text-success-custom">${formatCurrency(proj.pY15)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted-custom d-block mt-3">
                        • Future values compound today's current value (${formatCurrency(proj.portCurrent)}) at ${proj.portWCagr.toFixed(1)}% weighted CAGR<br>
                        • Past returns already included in current value
                    </small>
                </div>
            `).join('');
            container.innerHTML = grandHtml + html;
        }

        // ───────────────────── UPDATED SIP / LUMPSUM CALCULATOR (GROWW STYLE) ─────────────────────
        function calculateSipLumpsum() {
            const type = document.getElementById('investType').value;
            const rate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const years = parseInt(document.getElementById('periodYears').value) || 0;
            const months = years * 12;

            let invested = 0;
            let fv = 0;

            if (type === 'lumpsum') {
                const principal = parseFloat(document.getElementById('lumpsumAmt').value) || 0;
                invested = principal;
                fv = principal * Math.pow(1 + rate, years);               // true annual compounding
            } else {
                // ─── SIP (Groww / realistic effective monthly rate) ───
                const monthly = parseFloat(document.getElementById('monthlyAmt').value) || 0;
                invested = monthly * months;
                fv = invested;

                if (rate > 0) {
                    const r = Math.pow(1 + rate, 1/12) - 1;                // effective monthly rate from annual CAGR
                    fv = monthly * ((Math.pow(1 + r, months) - 1) / r) * (1 + r);  // beginning-of-month convention (standard in India)
                }
            }

            const returns = fv - invested;
            document.getElementById('investedAmt').textContent = formatCurrency(invested);
            document.getElementById('estReturns').textContent = formatCurrency(returns);
            document.getElementById('totalValue').textContent = formatCurrency(fv);
            document.getElementById('sipResults').classList.remove('d-none');
            renderCalculatorChart('sipChart', invested, returns);
        }

        function calculateStepUpSip() {
            const monthly = parseFloat(document.getElementById('stepMonthlyAmt').value) || 0;
            const step = parseFloat(document.getElementById('stepUpPct').value) / 100 || 0;
            const rate = parseFloat(document.getElementById('stepReturnRate').value) / 100 || 0;
            const years = parseInt(document.getElementById('stepPeriodYears').value) || 0;

            let invested = 0;
            let fv = 0;
            const totalMonths = years * 12;
            const r = rate > 0 ? Math.pow(1 + rate, 1/12) - 1 : 0;   // effective monthly rate

            for (let month = 0; month < totalMonths; month++) {
                const year = Math.floor(month / 12);
                const sipAmount = monthly * Math.pow(1 + step, year);
                invested += sipAmount;
                const growthPeriods = totalMonths - month;          // now matches regular SIP (beginning-of-month convention)
                fv += sipAmount * Math.pow(1 + r, growthPeriods);
            }

            const returns = fv - invested;
            document.getElementById('stepInvestedAmt').textContent = formatCurrency(invested);
            document.getElementById('stepEstReturns').textContent = formatCurrency(returns);
            document.getElementById('stepTotalValue').textContent = formatCurrency(fv);
            document.getElementById('stepSipResults').classList.remove('d-none');
            renderCalculatorChart('stepSipChart', invested, returns);
        }
        // ─────────────────────────────────────────────────────────────────────────────────────

        function renderCalculatorChart(chartId, invested, returns) {
            const canvas = document.getElementById(chartId);
            if (chartInstances[chartId]) chartInstances[chartId].destroy();
            chartInstances[chartId] = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Invested Amount', 'Est. Returns'],
                    datasets: [{
                        data: [invested, returns],
                        backgroundColor: ['#6b7280', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        // ────────────────────────────────────────────────
        // Start: password first
        // ────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            checkOrSetPassword();
        });
        window.openAddPortfolio = openAddPortfolio;
        window.editPortfolio = editPortfolio;
        window.deletePortfolio = deletePortfolio;
        window.addAssetRow = addAssetRow;
        window.removeAssetRow = removeAssetRow;
        window.updateAllocationTotal = updateAllocationTotal;
        window.savePortfolio = savePortfolio;
        window.saveReturns = saveReturns;
    </script>
</body>
</html>
